<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RGB Color Studio</title>
<style>
/* === RESET & VARS === */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0f0f0f;
  --surface: #1a1a1a;
  --surface2: #242424;
  --border: #333;
  --text: #e8e8e8;
  --muted: #888;
  --accent: #7c6af7;
  --rad: 8px;
  --t: 0.2s ease;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
}

/* === HEADER === */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.header-inner {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  align-items: stretch;
  gap: 24px;
}
.header-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 0;
  flex-shrink: 0;
}
.header-logo {
  font-size: 20px;
  color: var(--accent);
  transition: color var(--t);
  line-height: 1;
}
.header-title {
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: var(--text);
}
nav {
  display: flex;
  flex: 1;
}
.tab-btn {
  padding: 14px 24px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: color var(--t), border-color var(--t);
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--text); border-bottom-color: var(--accent); }

/* === PANELS === */
.tab-panel { display: none; padding: 24px; max-width: 1100px; margin: 0 auto; }
.tab-panel.active { display: block; }

/* === COLOR EXPLORER === */
#canvas-container {
  background: #0f0f0f;
  border-radius: var(--rad);
  overflow: hidden;
  border: 1px solid var(--border);
  margin-bottom: 20px;
}
#explorer-canvas { display: block; width: 100%; cursor: grab; }
#explorer-canvas:active { cursor: grabbing; }

.explorer-controls {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 16px;
}
.sp-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--rad);
  padding: 16px;
}
.sp-card h3 {
  margin-bottom: 12px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.07em;
  text-transform: uppercase;
}
.sp-card.red h3   { color: #ff6b6b; }
.sp-card.green h3 { color: #6be86b; }
.sp-card.blue h3  { color: #6b9fff; }

.sl-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.sl-row label {
  font-size: 11px;
  color: var(--muted);
  width: 64px;
  flex-shrink: 0;
}
.sl-row input[type=range] {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 4px;
  border-radius: 2px;
  background: var(--border);
  outline: none;
  cursor: pointer;
}
.sl-row input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
}
.sl-row input[type=range]::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
}
.sl-row .val {
  font-size: 11px;
  color: var(--muted);
  width: 34px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* === BUTTONS === */
.btn {
  padding: 8px 16px;
  border-radius: var(--rad);
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  transition: background var(--t), border-color var(--t);
}
.btn:hover { background: var(--border); }
.btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn.primary:hover { opacity: 0.85; }
.btn.sm { padding: 5px 12px; font-size: 12px; }

/* === PALETTE GENERATOR === */
.pal-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
  margin-bottom: 20px;
  background: var(--surface);
  padding: 16px;
  border-radius: var(--rad);
  border: 1px solid var(--border);
}
.ctl-group { display: flex; flex-direction: column; gap: 6px; }
.ctl-group label {
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.ctl-group input[type=color] {
  width: 56px;
  height: 36px;
  border: 1px solid var(--border);
  border-radius: var(--rad);
  background: var(--surface2);
  cursor: pointer;
  padding: 2px;
}
.ctl-group select {
  padding: 8px 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--rad);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
}
.toggle-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
.toggle-row input[type=checkbox] {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: var(--accent);
}

#swatches {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 16px;
  min-height: 92px;
}
.swatch {
  width: 90px;
  min-height: 90px;
  border-radius: var(--rad);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  padding: 6px;
  position: relative;
  border: 2px solid transparent;
  transition: transform var(--t), border-color var(--t);
  flex-shrink: 0;
}
.swatch:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.3); }
.hex-label {
  background: rgba(0,0,0,0.62);
  color: #fff;
  font-size: 11px;
  padding: 2px 5px;
  border-radius: 4px;
  font-family: monospace;
  width: 100%;
  text-align: center;
}
.a11y-icon {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #fff;
  color: #000;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  font-size: 10px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

.export-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }

/* === SIMULATOR === */
.sim-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--rad);
  padding: 16px;
  margin-bottom: 16px;
}
.sim-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0;
}
.sim-header h3 { font-size: 14px; font-weight: 600; }
.sim-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 14px;
}
.sim-type h4 {
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 8px;
}
.sim-swatches { display: flex; flex-wrap: wrap; gap: 6px; }
.sim-sw {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  flex-shrink: 0;
}

/* === CONTRAST CHECKER === */
.contrast-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}
.contrast-pickers {
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: var(--surface);
  padding: 20px;
  border-radius: var(--rad);
  border: 1px solid var(--border);
}
.contrast-pickers h3 { font-size: 15px; margin-bottom: 4px; }
.pick-row { display: flex; align-items: center; gap: 14px; }
.pick-row label { font-size: 13px; width: 90px; flex-shrink: 0; }
.pick-row input[type=color] {
  width: 52px;
  height: 44px;
  border: 1px solid var(--border);
  border-radius: var(--rad);
  background: none;
  cursor: pointer;
  padding: 3px;
}
.pick-row .hex-disp {
  font-family: monospace;
  font-size: 12px;
  color: var(--muted);
}
.preview-box {
  border-radius: var(--rad);
  padding: 20px;
  border: 1px solid var(--border);
}
.preview-large { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
.preview-normal { line-height: 1.5; margin-bottom: 5px; }
.preview-small { font-size: 12px; }

.contrast-results { display: flex; flex-direction: column; gap: 16px; }
.ratio-card {
  background: var(--surface);
  padding: 20px;
  border-radius: var(--rad);
  border: 1px solid var(--border);
}
.ratio-lbl { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px; }
.ratio-num {
  font-size: 38px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.badges-card {
  background: var(--surface);
  padding: 20px;
  border-radius: var(--rad);
  border: 1px solid var(--border);
}
.badges-card h4 {
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 12px;
}
.badge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.badge {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--rad);
  font-size: 13px;
  border: 1px solid var(--border);
  transition: background var(--t), border-color var(--t);
}
.badge .blabel { font-size: 11px; color: var(--muted); margin-top: 2px; }
.badge .dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.badge.pass { background: rgba(72,199,142,0.12); border-color: rgba(72,199,142,0.35); }
.badge.pass .dot { background: #48c78e; }
.badge.fail { background: rgba(255,80,80,0.12); border-color: rgba(255,80,80,0.35); }
.badge.fail .dot { background: #ff5050; }

/* === TOAST === */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--accent);
  color: #fff;
  padding: 8px 22px;
  border-radius: 20px;
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 999;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* === SECTION TITLE === */
.section-title {
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.07em;
  margin-bottom: 6px;
}

/* === RESPONSIVE === */
@media (max-width: 640px) {
  .tab-panel { padding: 14px; }
  .explorer-controls { grid-template-columns: 1fr; }
  .contrast-layout { grid-template-columns: 1fr; }
  .sim-grid { grid-template-columns: 1fr; }
  .pal-controls { flex-direction: column; }
  .tab-btn { padding: 10px 12px; font-size: 13px; }
  .header-inner { padding: 0 14px; flex-wrap: wrap; gap: 0; }
  .header-brand { padding: 10px 0; }
  .header-title { font-size: 13px; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="header-brand">
      <span class="header-logo">&#9679;</span>
      <span class="header-title">RGB Color Studio</span>
    </div>
    <nav>
      <button class="tab-btn active" data-tab="explorer">Color Explorer</button>
      <button class="tab-btn" data-tab="palette">Palette Generator</button>
      <button class="tab-btn" data-tab="contrast">Contrast Checker</button>
    </nav>
  </div>
</header>

<!-- ===== TAB 1: COLOR EXPLORER ===== -->
<section id="tab-explorer" class="tab-panel active">
  <div id="canvas-container">
    <canvas id="explorer-canvas"></canvas>
  </div>

  <div class="explorer-controls">
    <div class="sp-card red">
      <h3>Red</h3>
      <div class="sl-row">
        <label>Intensity</label>
        <input type="range" min="0" max="255" value="255" id="r-int">
        <span class="val" id="r-int-v">255</span>
      </div>
      <div class="sl-row">
        <label>Brightness</label>
        <input type="range" min="0" max="100" value="100" id="r-bri">
        <span class="val" id="r-bri-v">100%</span>
      </div>
    </div>
    <div class="sp-card green">
      <h3>Green</h3>
      <div class="sl-row">
        <label>Intensity</label>
        <input type="range" min="0" max="255" value="255" id="g-int">
        <span class="val" id="g-int-v">255</span>
      </div>
      <div class="sl-row">
        <label>Brightness</label>
        <input type="range" min="0" max="100" value="100" id="g-bri">
        <span class="val" id="g-bri-v">100%</span>
      </div>
    </div>
    <div class="sp-card blue">
      <h3>Blue</h3>
      <div class="sl-row">
        <label>Intensity</label>
        <input type="range" min="0" max="255" value="255" id="b-int">
        <span class="val" id="b-int-v">255</span>
      </div>
      <div class="sl-row">
        <label>Brightness</label>
        <input type="range" min="0" max="100" value="100" id="b-bri">
        <span class="val" id="b-bri-v">100%</span>
      </div>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <button class="btn" id="reset-btn">Reset Positions</button>
    <button class="btn" id="mode-btn">Switch to Particle Beam</button>
  </div>
</section>

<!-- ===== TAB 2: PALETTE GENERATOR ===== -->
<section id="tab-palette" class="tab-panel">
  <div class="pal-controls">
    <div class="ctl-group">
      <label>Base Color</label>
      <input type="color" id="base-color" value="#7c6af7">
    </div>
    <div class="ctl-group">
      <label>Palette Type</label>
      <select id="palette-type">
        <option value="complementary">Complementary</option>
        <option value="analogous">Analogous</option>
        <option value="triadic">Triadic</option>
        <option value="split-complementary">Split-Complementary</option>
        <option value="tetradic">Tetradic</option>
        <option value="monochromatic">Monochromatic</option>
      </select>
    </div>
    <div class="ctl-group">
      <label>&nbsp;</label>
      <div class="toggle-row">
        <input type="checkbox" id="accessible-mode">
        <label for="accessible-mode">Accessible Mode</label>
      </div>
    </div>
    <div class="ctl-group" id="bg-picker-wrap" style="display:none">
      <label>Against BG</label>
      <input type="color" id="accessible-bg" value="#ffffff">
    </div>
  </div>

  <div id="swatches"></div>

  <div class="export-row">
    <button class="btn primary" id="export-json">Export JSON</button>
    <button class="btn primary" id="export-png">Export PNG</button>
  </div>

  <!-- Color Blindness Simulator -->
  <div class="sim-section">
    <div class="sim-header">
      <h3>Color Blindness Simulator</h3>
      <button class="btn sm" id="toggle-sim">Show</button>
    </div>
    <div id="sim-content" style="display:none">
      <div class="sim-grid">
        <div class="sim-type">
          <h4>Protanopia (Red-Blind)</h4>
          <div class="sim-swatches" id="sim-protanopia"></div>
        </div>
        <div class="sim-type">
          <h4>Deuteranopia (Green-Blind)</h4>
          <div class="sim-swatches" id="sim-deuteranopia"></div>
        </div>
        <div class="sim-type">
          <h4>Tritanopia (Blue-Blind)</h4>
          <div class="sim-swatches" id="sim-tritanopia"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== TAB 3: CONTRAST CHECKER ===== -->
<section id="tab-contrast" class="tab-panel">
  <div class="contrast-layout">
    <div class="contrast-pickers">
      <h3>Color Selection</h3>
      <div class="pick-row">
        <label>Foreground</label>
        <input type="color" id="fg-color" value="#ffffff">
        <span class="hex-disp" id="fg-hex">#ffffff</span>
      </div>
      <div class="pick-row">
        <label>Background</label>
        <input type="color" id="bg-color" value="#000000">
        <span class="hex-disp" id="bg-hex">#000000</span>
      </div>
      <div style="margin-top: 4px;">
        <div class="section-title">Preview</div>
        <div class="preview-box" id="contrast-preview">
          <div class="preview-large">Large Text Sample</div>
          <p class="preview-normal">Normal text — readable body copy for paragraphs.</p>
          <p class="preview-small">Small text for captions and labels.</p>
        </div>
      </div>
    </div>

    <div class="contrast-results">
      <div class="ratio-card">
        <div class="ratio-lbl">Contrast Ratio</div>
        <div class="ratio-num" id="contrast-ratio">21.00:1</div>
      </div>
      <div class="badges-card">
        <h4>WCAG Compliance</h4>
        <div class="badge-grid">
          <div class="badge pass" id="badge-aa-n">
            <div><div style="font-weight:600">AA</div><div class="blabel">Normal ≥4.5:1</div></div>
            <div class="dot"></div>
          </div>
          <div class="badge pass" id="badge-aa-l">
            <div><div style="font-weight:600">AA</div><div class="blabel">Large ≥3:1</div></div>
            <div class="dot"></div>
          </div>
          <div class="badge pass" id="badge-aaa-n">
            <div><div style="font-weight:600">AAA</div><div class="blabel">Normal ≥7:1</div></div>
            <div class="dot"></div>
          </div>
          <div class="badge pass" id="badge-aaa-l">
            <div><div style="font-weight:600">AAA</div><div class="blabel">Large ≥4.5:1</div></div>
            <div class="dot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="toast" id="toast">Copied!</div>

<script>
// ============================================================
// UTILITIES
// ============================================================
function hexToRgb(hex) {
  return {
    r: parseInt(hex.slice(1,3), 16),
    g: parseInt(hex.slice(3,5), 16),
    b: parseInt(hex.slice(5,7), 16)
  };
}

function rgbToHex(r, g, b) {
  return '#' + [r, g, b]
    .map(v => Math.max(0, Math.min(255, Math.round(v))).toString(16).padStart(2,'0'))
    .join('');
}

function rgbToHsl(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h = 0, s = 0;
  const l = (max + min) / 2;
  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
      case g: h = ((b - r) / d + 2) / 6; break;
      case b: h = ((r - g) / d + 4) / 6; break;
    }
  }
  return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToRgb(h, s, l) {
  h /= 360; s /= 100; l /= 100;
  if (s === 0) {
    const v = Math.round(l * 255);
    return { r: v, g: v, b: v };
  }
  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  const p = 2 * l - q;
  const hue = (t) => {
    if (t < 0) t += 1;
    if (t > 1) t -= 1;
    if (t < 1/6) return p + (q - p) * 6 * t;
    if (t < 1/2) return q;
    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
    return p;
  };
  return {
    r: Math.round(hue(h + 1/3) * 255),
    g: Math.round(hue(h) * 255),
    b: Math.round(hue(h - 1/3) * 255)
  };
}

function hslToHex(h, s, l) {
  const { r, g, b } = hslToRgb(h, s, l);
  return rgbToHex(r, g, b);
}

// WCAG luminance
function luminance(r, g, b) {
  const lin = v => {
    v /= 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  };
  return 0.2126 * lin(r) + 0.7152 * lin(g) + 0.0722 * lin(b);
}

function contrastRatio(r1,g1,b1, r2,g2,b2) {
  const l1 = luminance(r1,g1,b1);
  const l2 = luminance(r2,g2,b2);
  const hi = Math.max(l1,l2), lo = Math.min(l1,l2);
  return (hi + 0.05) / (lo + 0.05);
}

// Color blindness matrices
function simProtanopia(r,g,b)   { return { r: 0.567*r+0.433*g, g: 0.558*r+0.442*g, b: 0.242*g+0.758*b }; }
function simDeuteranopia(r,g,b) { return { r: 0.625*r+0.375*g, g: 0.700*r+0.300*g, b: 0.300*g+0.700*b }; }
function simTritanopia(r,g,b)   { return { r: 0.950*r+0.050*b, g: 0.433*g+0.567*b, b: 0.475*g+0.525*b }; }

function applyMatrix(hex, fn) {
  const { r, g, b } = hexToRgb(hex);
  const s = fn(r, g, b);
  return rgbToHex(s.r, s.g, s.b);
}

function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1700);
}

// ============================================================
// TAB SWITCHING
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

// ============================================================
// FEATURE 1: COLOR EXPLORER (Canvas)
// ============================================================
const canvas = document.getElementById('explorer-canvas');
const ctx = canvas.getContext('2d');
const RADIUS = 130;

const spotlights = [
  { ch: 'r', x: 0.28, y: 0.42, intensity: 255, brightness: 1 },
  { ch: 'g', x: 0.72, y: 0.42, intensity: 255, brightness: 1 },
  { ch: 'b', x: 0.50, y: 0.72, intensity: 255, brightness: 1 },
];
const DEFAULTS = spotlights.map(s => ({ x: s.x, y: s.y }));
let dragging = null;
let beamMode = false;

function resizeCanvas() {
  const c = document.getElementById('canvas-container');
  canvas.width  = c.clientWidth;
  canvas.height = Math.round(Math.min(430, c.clientWidth * 0.52));
}

function drawSpotlight(sp, W, H) {
  const cx = sp.x * W, cy = sp.y * H;
  const eff = Math.round(sp.intensity * sp.brightness);
  let colorStr;
  if (sp.ch === 'r') colorStr = `rgb(${eff},0,0)`;
  else if (sp.ch === 'g') colorStr = `rgb(0,${eff},0)`;
  else colorStr = `rgb(0,0,${eff})`;
  const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, RADIUS);
  grad.addColorStop(0, colorStr);
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.beginPath();
  ctx.arc(cx, cy, RADIUS, 0, Math.PI * 2);
  ctx.fillStyle = grad;
  ctx.fill();
}

function drawBeam(sp, W, H) {
  const cx = sp.x * W, cy = sp.y * H;
  const eff = Math.round(sp.intensity * sp.brightness);
  let rv, gv, bv;
  if (sp.ch === 'r') { rv = eff; gv = 0; bv = 0; }
  else if (sp.ch === 'g') { rv = 0; gv = eff; bv = 0; }
  else { rv = 0; gv = 0; bv = eff; }
  // Draw ~90 particles scattered inside the spotlight radius
  for (let i = 0; i < 90; i++) {
    const angle = Math.random() * Math.PI * 2;
    // Square-root distribution so particles fill area uniformly
    const dist  = Math.sqrt(Math.random()) * RADIUS;
    const px = cx + Math.cos(angle) * dist;
    const py = cy + Math.sin(angle) * dist;
    const alpha = (1 - dist / RADIUS) * (0.5 + Math.random() * 0.5);
    const size  = 1 + Math.random() * 3.5;
    ctx.beginPath();
    ctx.arc(px, py, size, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${rv},${gv},${bv},${alpha.toFixed(2)})`;
    ctx.fill();
  }
}

function drawFrame() {
  const W = canvas.width, H = canvas.height;
  ctx.fillStyle = '#0f0f0f';
  ctx.fillRect(0, 0, W, H);
  ctx.globalCompositeOperation = 'screen';
  spotlights.forEach(sp => {
    if (beamMode) drawBeam(sp, W, H);
    else drawSpotlight(sp, W, H);
  });
  ctx.globalCompositeOperation = 'source-over';
  requestAnimationFrame(drawFrame);
}

resizeCanvas();
drawFrame();
window.addEventListener('resize', resizeCanvas);

// Slider wiring
[
  ['r-int', 'r-int-v', 0, 'intensity'],
  ['g-int', 'g-int-v', 1, 'intensity'],
  ['b-int', 'b-int-v', 2, 'intensity'],
  ['r-bri', 'r-bri-v', 0, 'brightness'],
  ['g-bri', 'g-bri-v', 1, 'brightness'],
  ['b-bri', 'b-bri-v', 2, 'brightness'],
].forEach(([id, vid, idx, prop]) => {
  const el = document.getElementById(id);
  const disp = document.getElementById(vid);
  el.addEventListener('input', () => {
    const v = parseInt(el.value);
    if (prop === 'intensity') {
      spotlights[idx].intensity = v;
      disp.textContent = v;
    } else {
      spotlights[idx].brightness = v / 100;
      disp.textContent = v + '%';
    }
  });
});

document.getElementById('reset-btn').addEventListener('click', () => {
  spotlights.forEach((sp, i) => { sp.x = DEFAULTS[i].x; sp.y = DEFAULTS[i].y; });
});

document.getElementById('mode-btn').addEventListener('click', () => {
  beamMode = !beamMode;
  document.getElementById('mode-btn').textContent =
    beamMode ? 'Switch to Spotlight' : 'Switch to Particle Beam';
});

// Drag logic
function canvasPos(e) {
  const rect = canvas.getBoundingClientRect();
  const sx = canvas.width  / rect.width;
  const sy = canvas.height / rect.height;
  const src = e.touches ? e.touches[0] : e;
  return { x: (src.clientX - rect.left) * sx, y: (src.clientY - rect.top) * sy };
}

function hitTest(pos) {
  for (let i = spotlights.length - 1; i >= 0; i--) {
    const sp = spotlights[i];
    const dx = pos.x - sp.x * canvas.width;
    const dy = pos.y - sp.y * canvas.height;
    if (Math.sqrt(dx*dx + dy*dy) < RADIUS) return i;
  }
  return null;
}

function clamp01(v) { return Math.max(0, Math.min(1, v)); }

canvas.addEventListener('mousedown', e => { dragging = hitTest(canvasPos(e)); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); dragging = hitTest(canvasPos(e)); }, { passive: false });
window.addEventListener('mousemove', e => {
  if (dragging === null) return;
  const p = canvasPos(e);
  spotlights[dragging].x = clamp01(p.x / canvas.width);
  spotlights[dragging].y = clamp01(p.y / canvas.height);
});
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (dragging === null) return;
  const p = canvasPos(e);
  spotlights[dragging].x = clamp01(p.x / canvas.width);
  spotlights[dragging].y = clamp01(p.y / canvas.height);
}, { passive: false });
window.addEventListener('mouseup',  () => { dragging = null; });
window.addEventListener('touchend', () => { dragging = null; });

// ============================================================
// FEATURE 2: PALETTE GENERATOR
// ============================================================
let currentPalette = [];

function generatePalette(hex, type) {
  const { r, g, b } = hexToRgb(hex);
  const { h, s, l } = rgbToHsl(r, g, b);
  switch (type) {
    case 'complementary':
      return [hslToHex(h, s, l), hslToHex((h+180)%360, s, l)];
    case 'analogous':
      return [-60,-30,0,30,60].map(o => hslToHex((h+o+360)%360, s, l));
    case 'triadic':
      return [0,120,240].map(o => hslToHex((h+o)%360, s, l));
    case 'split-complementary':
      return [hslToHex(h,s,l), hslToHex((h+150)%360,s,l), hslToHex((h+210)%360,s,l)];
    case 'tetradic':
      return [0,90,180,270].map(o => hslToHex((h+o)%360, s, l));
    case 'monochromatic':
      return [20,35,50,65,80].map(lv => hslToHex(h, s, lv));
    default:
      return [hex];
  }
}

function makeAccessible(hex, bgHex) {
  const bg = hexToRgb(bgHex);
  let { r, g, b } = hexToRgb(hex);
  if (contrastRatio(r, g, b, bg.r, bg.g, bg.b) >= 4.5) return { hex, adjusted: false };
  let { h, s, l } = rgbToHsl(r, g, b);
  const darken = luminance(bg.r, bg.g, bg.b) > 0.5;
  let best = hex;
  for (let i = 0; i < 20; i++) {
    l = darken ? Math.max(0, l - 4) : Math.min(100, l + 4);
    const rgb = hslToRgb(h, s, l);
    best = rgbToHex(rgb.r, rgb.g, rgb.b);
    if (contrastRatio(rgb.r, rgb.g, rgb.b, bg.r, bg.g, bg.b) >= 4.5) break;
  }
  return { hex: best, adjusted: true };
}

function renderPalette() {
  const baseHex  = document.getElementById('base-color').value;
  const type     = document.getElementById('palette-type').value;
  const a11y     = document.getElementById('accessible-mode').checked;
  const bgHex    = document.getElementById('accessible-bg').value;

  // Spec: "Accent colors pulled from the currently selected/active palette"
  document.documentElement.style.setProperty('--accent', baseHex);

  const raw = generatePalette(baseHex, type);
  currentPalette = [];
  const container = document.getElementById('swatches');
  container.innerHTML = '';

  raw.forEach(hex => {
    let final = hex, adjusted = false;
    if (a11y) {
      const res = makeAccessible(hex, bgHex);
      final = res.hex;
      adjusted = res.adjusted;
    }
    currentPalette.push(final);

    const sw = document.createElement('div');
    sw.className = 'swatch';
    sw.style.background = final;

    const lbl = document.createElement('div');
    lbl.className = 'hex-label';
    lbl.textContent = final;
    sw.appendChild(lbl);

    if (adjusted) {
      const icon = document.createElement('div');
      icon.className = 'a11y-icon';
      icon.textContent = 'A';
      icon.title = 'Adjusted for ≥4.5:1 contrast';
      sw.appendChild(icon);
    }

    sw.addEventListener('click', () => {
      navigator.clipboard.writeText(final).catch(() => {});
      showToast();
    });

    container.appendChild(sw);
  });

  renderSimulator();
}

['base-color', 'palette-type', 'accessible-bg'].forEach(id => {
  document.getElementById(id).addEventListener('input', renderPalette);
  document.getElementById(id).addEventListener('change', renderPalette);
});

document.getElementById('accessible-mode').addEventListener('change', e => {
  document.getElementById('bg-picker-wrap').style.display = e.target.checked ? 'block' : 'none';
  renderPalette();
});

// Export JSON
document.getElementById('export-json').addEventListener('click', () => {
  const json = JSON.stringify(currentPalette, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([json], { type: 'application/json' }));
  a.download = 'palette.json';
  a.click();
});

// Export PNG
document.getElementById('export-png').addEventListener('click', () => {
  const SW = 100, SH = 100, PAD = 10;
  const W = currentPalette.length * (SW + PAD) + PAD;
  const H = SH + PAD * 2;
  const c = document.createElement('canvas');
  c.width = W; c.height = H;
  const x = c.getContext('2d');
  x.fillStyle = '#0f0f0f';
  x.fillRect(0, 0, W, H);
  currentPalette.forEach((hex, i) => {
    const xOff = PAD + i * (SW + PAD);
    x.fillStyle = hex;
    x.fillRect(xOff, PAD, SW, SH);
    x.fillStyle = 'rgba(0,0,0,0.6)';
    x.fillRect(xOff, PAD + SH - 22, SW, 22);
    x.fillStyle = '#fff';
    x.font = '11px monospace';
    x.fillText(hex, xOff + 7, PAD + SH - 7);
  });
  const a = document.createElement('a');
  a.href = c.toDataURL('image/png');
  a.download = 'palette.png';
  a.click();
});

// ============================================================
// FEATURE 4: COLOR BLINDNESS SIMULATOR
// ============================================================
function renderSimulator() {
  const sims = [
    { id: 'sim-protanopia',   fn: simProtanopia },
    { id: 'sim-deuteranopia', fn: simDeuteranopia },
    { id: 'sim-tritanopia',   fn: simTritanopia },
  ];
  sims.forEach(({ id, fn }) => {
    const el = document.getElementById(id);
    el.innerHTML = '';
    currentPalette.forEach(hex => {
      const d = document.createElement('div');
      d.className = 'sim-sw';
      d.style.background = applyMatrix(hex, fn);
      el.appendChild(d);
    });
  });
}

document.getElementById('toggle-sim').addEventListener('click', () => {
  const content = document.getElementById('sim-content');
  const btn     = document.getElementById('toggle-sim');
  const showing = content.style.display !== 'none';
  content.style.display = showing ? 'none' : 'block';
  btn.textContent = showing ? 'Show' : 'Hide';
});

// ============================================================
// FEATURE 3: CONTRAST CHECKER
// ============================================================
function updateContrast() {
  const fg = document.getElementById('fg-color').value;
  const bg = document.getElementById('bg-color').value;
  document.getElementById('fg-hex').textContent = fg;
  document.getElementById('bg-hex').textContent = bg;

  const fgRgb = hexToRgb(fg);
  const bgRgb = hexToRgb(bg);
  const ratio = contrastRatio(fgRgb.r, fgRgb.g, fgRgb.b, bgRgb.r, bgRgb.g, bgRgb.b);
  document.getElementById('contrast-ratio').textContent = ratio.toFixed(2) + ':1';

  const preview = document.getElementById('contrast-preview');
  preview.style.color = fg;
  preview.style.background = bg;

  function badge(id, pass) {
    document.getElementById(id).className = 'badge ' + (pass ? 'pass' : 'fail');
  }
  badge('badge-aa-n',  ratio >= 4.5);
  badge('badge-aa-l',  ratio >= 3.0);
  badge('badge-aaa-n', ratio >= 7.0);
  badge('badge-aaa-l', ratio >= 4.5);
}

document.getElementById('fg-color').addEventListener('input', updateContrast);
document.getElementById('bg-color').addEventListener('input', updateContrast);

// ============================================================
// INIT
// ============================================================
renderPalette();
updateContrast();
</script>
</body>
</html>
